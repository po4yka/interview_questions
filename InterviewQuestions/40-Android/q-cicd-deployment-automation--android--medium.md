---
id: 20251012-122797
title: CI/CD Deployment Automation / Автоматизация деплоя в CI/CD
aliases:
- CI/CD Deployment Automation
- Автоматизация деплоя в CI/CD
topic: android
subtopics:
- gradle
- release-management
question_kind: android
difficulty: medium
status: reviewed
moc: moc-android
related:
- q-build-optimization-gradle--gradle--medium
- q-android-lint-tool--android--medium
- q-app-store-optimization--distribution--medium
created: 2025-10-15
updated: 2025-10-20
original_language: en
language_tags:
- en
- ru
tags:
- android/gradle
- release
- ci-cd
- deployment
- play
- fastlane
- difficulty/medium
- android/release-management
---# Вопрос (RU)
> Как автоматизировать деплой Android‑приложения в CI/CD (подпись, версионирование, артефакты, дистрибуция, release‑ворота и откат)?

---

# Question (EN)
> How do you automate Android app deployment in CI/CD (build signing, versioning, artifacts, distribution, release gates, and rollback)?

## Ответ (RU)

### Цели
- Воспроизводимые подписанные сборки; отслеживаемые версии
- Безопасный поэтапный rollout с быстрым откатом
- Аудит артефактов и заметок релиза

### Конвейер релиза (высокоуровнево)
- Сборка → Подпись → Проверки (lint/tests) → Загрузка (internal) → Ворота → Промоут (alpha/beta/prod) → Мониторинг → Откат

### Версионирование
- Единый источник правды (Gradle): авто‑bump на main; встраивать git SHA/дату.
- Семантика или монотонный `versionCode`; авто‑`versionName`.

### Подпись
- Play App Signing; upload‑keystore хранить в секретах CI (OIDC/secret store).
- Подписывать через Gradle `signingConfig` с инъекцией секретов; не коммитить keystore.

### Артефакты
- Генерировать AAB (основной) и APK (внутреннее тестирование) + mapping.txt + отчёты R8.
- Загружать в артефакты CI и Play internal track.

### Дистрибуция
- Internal для мерджей; alpha/beta для этапного раската; промоут по SLO/метрикам.
- Release notes из CHANGELOG/conv. commits автоматически.

### Минимальный шаг деплоя (GitHub Actions)
```yaml
name: Deploy
on: [workflow_dispatch]
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: '17' }
      - uses: gradle/gradle-build-action@v2
      - name: Build release AAB
        run: ./gradlew :app:bundleRelease --configuration-cache --build-cache
      - name: Upload to Play (internal)
        env:
          JSON_KEY: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$JSON_KEY" > sa.json
          ./gradlew publishBundle --no-daemon -Pandroid.injected.signing.store.file=$SIGN_STORE \
            -Pandroid.injected.signing.store.password=$SIGN_PASS \
            -Pandroid.injected.signing.key.alias=$SIGN_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASS \
            -Pplay.service.account.json=sa.json -Pplay.track=internal
```

### Ворота и раскат
- Ворота: тесты, линт, min покрытие, crash‑free порог на internal.
- Этапный rollout (5% → 20% → 50% → 100%); авто‑промоут при норме метрик.

### Откат
- Хранить последний стабильный артефакт + mapping; в Play можно остановить и откатить до предыдущего.
- Автоматизировать “halt + promote previous build”.

### Наблюдаемость
- Дашборд релиза: SHA, версия, трек, %, crash, ANR, KPI.

---

## Answer (EN)

### Goals
- Reproducible signed builds; traceable versions
- Safe, staged rollout with fast rollback
- Auditable artifacts and release notes

### Release pipeline (high level)
- Build → Sign → Scan (lint/tests) → Upload (internal) → Gates → Promote (alpha/beta/production) → Monitor → Rollback

### Versioning
- Single source of truth (Gradle): auto‑bump on main; embed git SHA/date.
- Semantic or monotonic `versionCode`; auto‑generate `versionName`.

### Signing
- Use Play App Signing; keep upload keystore in CI secrets (OIDC/secret store).
- Sign via Gradle `signingConfig` with injected env secrets; never commit keystores.

### Artifacts
- Produce AAB (primary) and APK (for internal testing) + mapping.txt + ProGuard/R8 reports.
- Upload artifacts to CI (artifacts) and Play internal track.

### Distribution
- Internal track for PR merges; alpha/beta for staged users; promote on SLOs/metrics.
- Release notes autogenerated from conventional commits/CHANGELOG.

### Minimal CI deploy step (GitHub Actions)
```yaml
name: Deploy
on: [workflow_dispatch]
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: '17' }
      - uses: gradle/gradle-build-action@v2
      - name: Build release AAB
        run: ./gradlew :app:bundleRelease --configuration-cache --build-cache
      - name: Upload to Play (internal)
        env:
          JSON_KEY: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$JSON_KEY" > sa.json
          ./gradlew publishBundle --no-daemon -Pandroid.injected.signing.store.file=$SIGN_STORE \
            -Pandroid.injected.signing.store.password=$SIGN_PASS \
            -Pandroid.injected.signing.key.alias=$SIGN_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASS \
            -Pplay.service.account.json=sa.json -Pplay.track=internal
```

### Gates and rollout
- Gates: test pass, lint clean, min coverage, crash‑free sessions threshold in internal.
- Staged rollout (e.g., 5% → 20% → 50% → 100%); auto‑promote if metrics OK.

### Rollback
- Keep last stable artifact + mapping; Play console supports halt and roll back by previous release.
- Automate “halt + promote previous build” command.

### Observability
- Release dashboard: build SHA, version, track, rollout %, crash rate, ANR, key KPIs.

## Follow-ups
- How to secure signing keys and Play service accounts in CI?
- How to design staged rollout policies and auto‑promote rules?
- How to implement release notes and changelog automation?

## References
- https://developer.android.com/studio/publish
- https://docs.gradle.org/current/userguide/build_cache.html
- https://github.com/Triple-T/gradle-play-publisher

## Related Questions

### Prerequisites (Easier)
- [[q-build-optimization-gradle--android--medium]]

### Related (Same Level)
- [[q-android-lint-tool--android--medium]]
- [[q-cicd-automated-testing--android--medium]]

### Advanced (Harder)
- [[q-app-store-optimization--android--medium]]

