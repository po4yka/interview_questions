name: Vault Health Report

on:
  # Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'

  # Allow manual trigger
  workflow_dispatch:

  # Run on push to main (for testing)
  push:
    branches:
      - main
    paths:
      - '.github/workflows/vault-health-report.yml'

permissions:
  contents: write
  issues: write

jobs:
  health-report:
    name: Generate Vault Health Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install automation package
        run: |
          cd automation
          uv sync

      - name: Generate comprehensive health report
        run: |
          cd automation

          # Create reports directory
          mkdir -p ../reports

          # Generate link health report
          echo "Generating link health report..."
          uv run vault link-report --output ../reports/link-health-report.md

          # Find orphaned notes
          echo "Finding orphaned notes..."
          uv run vault orphans --output ../reports/orphaned-notes.txt

          # Find broken links
          echo "Finding broken links..."
          uv run vault broken-links --output ../reports/broken-links.txt || true

          # Generate graph statistics
          echo "Generating graph statistics..."
          uv run vault graph-stats --hubs 20 --authorities 20 > ../reports/graph-stats.txt

          # Find missing translations
          echo "Finding missing translations..."
          uv run vault check-translations --output ../reports/missing-translations.txt

          # Run full vault validation
          echo "Running full vault validation..."
          uv run vault validate --all --report ../reports/validation-report.md --quiet || true

      - name: Generate summary report
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          cat > reports/VAULT-HEALTH-SUMMARY.md << EOF
          # Vault Health Report

          **Generated**: ${TIMESTAMP}
          **Repository**: ${{ github.repository }}
          **Commit**: ${{ github.sha }}

          ---

          ## Quick Stats

          EOF

          # Add vault statistics
          cd automation
          uv run vault graph-stats >> ../reports/VAULT-HEALTH-SUMMARY.md

          cat >> reports/VAULT-HEALTH-SUMMARY.md << 'EOF'

          ---

          ## Detailed Reports

          - [Link Health Report](./link-health-report.md) - Comprehensive link analysis
          - [Validation Report](./validation-report.md) - Full vault validation results
          - [Graph Statistics](./graph-stats.txt) - Network analysis
          - [Orphaned Notes](./orphaned-notes.txt) - Notes with no links
          - [Broken Links](./broken-links.txt) - Links to non-existent notes
          - [Missing Translations](./missing-translations.txt) - Notes missing EN or RU

          ---

          ## Actions Required

          EOF

          # Check for critical issues
          if [ -f "reports/orphaned-notes.txt" ] && [ -s "reports/orphaned-notes.txt" ]; then
            ORPHAN_COUNT=$(wc -l < reports/orphaned-notes.txt)
            echo "- **$ORPHAN_COUNT orphaned notes** need linking" >> reports/VAULT-HEALTH-SUMMARY.md
          fi

          if [ -f "reports/broken-links.txt" ] && [ -s "reports/broken-links.txt" ]; then
            echo "- **Broken links detected** - review broken-links.txt" >> reports/VAULT-HEALTH-SUMMARY.md
          fi

          if [ -f "reports/missing-translations.txt" ] && [ -s "reports/missing-translations.txt" ]; then
            MISSING_COUNT=$(wc -l < reports/missing-translations.txt)
            echo "- **$MISSING_COUNT notes** need translations" >> reports/VAULT-HEALTH-SUMMARY.md
          fi

          cat >> reports/VAULT-HEALTH-SUMMARY.md << 'EOF'

          ---

          ## Automation

          This report is automatically generated by the [Vault Health Report](.github/workflows/vault-health-report.yml) workflow.

          - **Frequency**: Daily at 00:00 UTC
          - **Manual trigger**: Available via workflow_dispatch
          - **Tools**: [automation/](./automation/) package v0.8.0

          EOF

      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vault-health-reports
          path: reports/
          retention-days: 90

      - name: Commit reports to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check if reports branch exists on remote
          if git ls-remote --heads origin reports | grep -q reports; then
            echo "Reports branch exists, fetching..."
            git fetch origin reports
            git checkout reports
          else
            echo "Reports branch does not exist, creating..."
            git checkout --orphan reports
            git rm -rf . || true
          fi

          # Copy reports
          mkdir -p vault-reports
          cp -r reports/* vault-reports/

          # Add timestamp
          echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > vault-reports/last-updated.txt

          git add vault-reports/
          git commit -m "chore: update vault health reports [skip ci]" || echo "No changes to commit"

      - name: Push reports
        run: |
          git push origin reports --force-with-lease || git push origin reports --set-upstream

      - name: Create GitHub Issue for critical problems
        if: hashFiles('reports/broken-links.txt') != '' || hashFiles('reports/orphaned-notes.txt') != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read reports
            let brokenLinks = '';
            let orphanedNotes = '';

            try {
              brokenLinks = fs.readFileSync('reports/broken-links.txt', 'utf8');
            } catch (e) {
              brokenLinks = 'No broken links';
            }

            try {
              orphanedNotes = fs.readFileSync('reports/orphaned-notes.txt', 'utf8');
            } catch (e) {
              orphanedNotes = 'No orphaned notes';
            }

            // Count issues
            const brokenCount = brokenLinks.split('\n').filter(line => line.trim()).length;
            const orphanCount = orphanedNotes.split('\n').filter(line => line.trim()).length;

            if (brokenCount === 0 && orphanCount === 0) {
              console.log('No critical issues found');
              return;
            }

            // Create issue body
            let body = `## Vault Health Issues Detected

            **Generated**: ${new Date().toISOString()}
            **Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---

            `;

            if (brokenCount > 0) {
              body += `### Broken Links (${brokenCount})

            \`\`\`
            ${brokenLinks.slice(0, 2000)}
            \`\`\`

            `;
            }

            if (orphanCount > 0) {
              body += `### Orphaned Notes (${orphanCount})

            \`\`\`
            ${orphanedNotes.slice(0, 2000)}
            \`\`\`

            `;
            }

            body += `---

            **Full reports**: See [vault-reports](../tree/reports/vault-reports) branch`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'vault-health'
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log('Updated existing health issue');
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Vault Health Issues: ${brokenCount} broken links, ${orphanCount} orphaned notes`,
                body: body,
                labels: ['vault-health', 'automated']
              });
              console.log('Created new health issue');
            }

      - name: Add job summary
        run: |
          echo "# Vault Health Report" >> $GITHUB_STEP_SUMMARY
          cat reports/VAULT-HEALTH-SUMMARY.md >> $GITHUB_STEP_SUMMARY
