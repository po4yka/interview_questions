name: LLM Note Polishing

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (do not modify files)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      pattern:
        description: 'File pattern to process (e.g., InterviewQuestions/**/*.md)'
        required: false
        default: 'InterviewQuestions/**/*.md'
      max_iterations:
        description: 'Maximum fix iterations per note'
        required: false
        default: '5'
      create_pr:
        description: 'Create PR with changes (only when dry_run=false)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    # Run weekly on Sunday at 2 AM UTC (dry-run only)
    - cron: '0 2 * * 0'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  llm-review:
    name: LLM-based Note Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install automation package
        run: |
          cd automation
          uv sync

      - name: Set up environment variables
        run: |
          # Set defaults for scheduled runs
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "DRY_RUN=true" >> $GITHUB_ENV
            echo "CREATE_PR=false" >> $GITHUB_ENV
            echo "PATTERN=InterviewQuestions/**/*.md" >> $GITHUB_ENV
            echo "MAX_ITERATIONS=5" >> $GITHUB_ENV
          else
            # Use workflow_dispatch inputs
            echo "DRY_RUN=${{ github.event.inputs.dry_run || 'true' }}" >> $GITHUB_ENV
            echo "CREATE_PR=${{ github.event.inputs.create_pr || 'true' }}" >> $GITHUB_ENV
            echo "PATTERN=${{ github.event.inputs.pattern || 'InterviewQuestions/**/*.md' }}" >> $GITHUB_ENV
            echo "MAX_ITERATIONS=${{ github.event.inputs.max_iterations || '5' }}" >> $GITHUB_ENV
          fi

      - name: Run LLM review
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          cd automation

          # Determine dry-run flag
          if [ "$DRY_RUN" == "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          else
            DRY_RUN_FLAG="--no-dry-run"
          fi

          # Run LLM review
          uv run vault-app llm-review \
            --pattern "$PATTERN" \
            $DRY_RUN_FLAG \
            --max-iterations "$MAX_ITERATIONS" \
            --report ../llm-review-report.md \
            --backup

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: llm-review-report
          path: llm-review-report.md
          retention-days: 30

      - name: Create PR with changes
        if: env.DRY_RUN == 'false' && env.CREATE_PR == 'true'
        run: |
          # Check if there are changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit"
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          BRANCH_NAME="llm-review/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          # Add changes
          git add InterviewQuestions/**/*.md
          git add InterviewQuestions/**/*.md.backup 2>/dev/null || true

          # Commit
          git commit -m "feat: LLM-based note review and fixes

          This commit contains automated improvements to notes using LLM review:
          - Technical accuracy improvements
          - Formatting and structure fixes
          - Compliance with vault rules

          Pattern: $PATTERN
          Max iterations: $MAX_ITERATIONS

          Generated by: ${{ github.workflow }}
          Run: ${{ github.run_id }}"

          # Push
          git push -u origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "LLM Review: Automated note improvements" \
            --body "$(cat <<'EOF'
          ## Summary

          This PR contains automated improvements to notes using the LLM review system.

          **Review settings**:
          - Pattern: $PATTERN
          - Max iterations: $MAX_ITERATIONS
          - Workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Changes

          The LLM review system performed:
          1. Technical/factual review of note content
          2. Iterative fixing of formatting and structure issues
          3. Validation against vault rules

          ## Report

          See the detailed report in the workflow artifacts.

          ## Testing

          Please review the changes carefully, especially:
          - Technical accuracy of any modified explanations
          - Code examples remain correct
          - YAML frontmatter is properly formatted
          - Bilingual structure is preserved

          EOF
          )" \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add workflow summary
        if: always()
        run: |
          echo "## LLM Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Settings**:" >> $GITHUB_STEP_SUMMARY
          echo "- Dry run: $DRY_RUN" >> $GITHUB_STEP_SUMMARY
          echo "- Pattern: $PATTERN" >> $GITHUB_STEP_SUMMARY
          echo "- Max iterations: $MAX_ITERATIONS" >> $GITHUB_STEP_SUMMARY
          echo "- Create PR: $CREATE_PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "llm-review-report.md" ]; then
            echo "### Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat llm-review-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No report generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on failure
        if: failure() && github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            // Find if there's an open issue about LLM review failures
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'llm-review-failure'
            });

            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'LLM Review Workflow Failed',
                body: `The LLM review workflow failed.\n\nRun: [${context.runId}](${runUrl})\n\nPlease check the workflow logs for details.`,
                labels: ['llm-review-failure', 'automation']
              });
            }
